# Ближайший автобус #
База данных городских автобусов  с внедренным приложением телеграмм бота и бота для Алисы.
Проект написан на Django. 
Основная часть взаимодействия с программой выполняется через интерфейс телеграмм.
Некоторые функции доступны через веб-интерфейс админ-панель Django.

## Функционал приложения ##
- Позволяет подготовить маршруты по которым можно будет оперативно получать информацию 
о движении автобусов (маршрут задается указанием начальной и конечной остановки).
- Отображает расписание отправления выбранных автобусов на конкретной остановке 
в реальном времени, на выбранный период времени.
- Автоматически определяет текущее время и день недели для показа расписания.
- Дает возможность посмотреть полное расписание всех автобусов на этой остановке 
за конкретный день недели.
- Позволяет выбрать интересующие автобусы на выбранной начальной остановке, период
времени, на который будет показано расписание, вид расписания (по времени или по автобусам). 
Дать произвольное имя настроенному маршруту.
- Имеет возможность переназначать дни. Т.е. задать дату и указать каким днем недели эту дату 
будет считать программа, что позволяет правильно отображать расписание на праздничные и перенесенные дни.
- Показывает Help - краткую справку по использованию программы.
- Позволяет отправить сообщение разработчику и получать ответ прямо внутри бота.
- Имеет встроенный модуль (парсер) для получения расписания автобусов с сайта [Миноблавтотранс](https://gpmopt.by/mopt/Home/Index/sluck#/routes/bus).
- С помощью специальной команды может импортировать расписание полученное в результате парсинга в базу данных программы.
- Позволяет администраторам бота просматривать статистику использования бота.
- Имеет модуль для работы с Алисой. Позволяет получать расписание автобусов через голосового помощника.

## Разворачивание проекта ##

### Подготовка сервера ###

Необходимо подготовить сервер, установить PIP, GIT, virtualenv, Docker, Docker-compose (если предполагается работа в контейнере).
Клонировать репозиторий проекта с GitHub:  
`git@github.com:avdivo/nearest_bus.git`  

Зайти в папку проекта. Создать виртуальное окружение:  
`virtualenv venv`

Активировать виртуальное окружение:  
`source venv/bin/activate`  

Установить зависимости:  
`pip install -r requirements.txt`  

Выполнить миграции:  
`python manage.py migrate`

Создать суперпользователя:  
`python manage.py createsuperuser`

### Создание телеграмм бота ###
Необходимо создать телеграмм бота с помощью BotFather и получить токен.

### Настройка проекта ###
Создать файл .env в корне проекта и добавить в него следующие переменные:  
```
SECRET_KEY=""  # Секретный ключ проекта Django
BOT_TOKEN=""  # Токен телеграмм бота
ADMINS=[xxxxxxxxx, yyyyyyyyy]  # id в Телеграмм администраторов бота
```
### Прздничные и перенесенные дни ###
Через админку в таблицу Праздники добавляются праздничные и перенесенные дни.  
Указывается дата и день недели, которым будет считаться эта дата.  
Даты содержат год, поэтому заполняться они должны постоянно. 

### Импорт расписания ###
Расписание импортируется с сайта [Миноблавтотранс](https://gpmopt.by/mopt/Home/Index/sluck#/routes/bus).  
Импорт происходит в файл result.json с помощью файла import_schedule.py.  
Далее командой import расписание записывается в БД.  
Таблицы при этом должны быть созданы они будут перезаписаны. Список таблиц см. ниже.  
При импорте вносятся изменения в данные, относительно исходного расписания, 
их можно посмотреть в файле schedule/management/commands/import.py.

### Таблицы приложения ###
alisa_alisauser - пользователи Алисы  
schedule_bus - автобусы (очистить перед импортом)  
schedule_busstop - остановки (очистить перед импортом)  
schedule_busstop_con_from - связь остановок с маршрутами (очистить перед импортом)  
schedule_busstop_con_to - связь остановок с маршрутами (очистить перед импортом)  
schedule_bus_station - остановки на маршруте (очистить перед импортом)  
schedule_holiday - праздничные и перенесенные дни  
schedule_optionsforstopnames - варианты названий остановок  
schedule_order - порядок остановок на маршруте (очистить перед импортом)  
schedule_router - маршруты (очистить перед импортом)  
schedule_schedule - расписание автобусов (очистить перед импортом)  
tbot_botuser - пользователи бота  
tbot_idsforname - внутренняя таблица для бота для замены названий кнопок идефикаторами  
tbot_parameter - настройки пользователей  

## Команды бота ##
start - Перезапуск бота
help - Помощь
message - Сообщение разработчику. Через эту же команду можно ответить пользователю, но в начале сообщения нужно указать команду, которая появляется под сообщением пользователя.
stat - доступна только для администраторы, отсутствует в меню. Показывает короткую статистику использования бота.  

Регистрация пользователя в боте не требуется, происходит автоматически по команде start.

## Алиса ##
Для правильного распознавания остановок и команд необходимо заполнить таблицу Вариант названия автобусной остановки. 
В таблицу данные можно добавить через админку.
Также есть 2 команды:  
add_options_name_for_bus_stop - для добавления вариантов названий остановок из файла names_bus_stops.json (в корне проекта),  
save_options_name_for_bus_stop - для сохранения в файл из БД.  
В самой программе в файле alisa/services/analizer.py есть список слов, которые должны удаляться из фразы которую говорит пользователь Алисе, чтобы в дальнейшем они не анализировались.  
Регистрация пользователей происходит автоматически.  
Для работы Алисы на сайте Yandex в Яндекс.Диалоги нужно создать диалог и указать в нем путь к эндпоинту программы на сервере.



