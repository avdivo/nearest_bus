# Ближайший автобус #
База данных городских автобусов  с внедренным приложением телеграмм бота и бота для Алисы.
Проект написан на Django. 
Основная часть взаимодействия с программой выполняется через интерфейс телеграмм.
Некоторые функции доступны через веб-интерфейс админ-панель Django.

## Функционал приложения ##
- Позволяет подготовить маршруты по которым можно будет оперативно получать информацию 
о движении автобусов (маршрут задается указанием начальной и конечной остановки).
- Отображает расписание отправления выбранных автобусов на конкретной остановке 
в реальном времени, на выбранный период времени.
- Автоматически определяет текущее время и день недели для показа расписания.
- Дает возможность посмотреть полное расписание всех автобусов на этой остановке и на одноименной обратной, если она есть за конкретный день недели.
- Позволяет выбрать интересующие автобусы на начальной остановке, период времени, на который будет показано расписание. Дать произвольное имя настроенному маршруту.
- Имеет возможность переназначать дни. Т.е. задать дату и указать каким днем недели эту дату будет считать программа, что позволяет правильно отображать расписание на праздничные и перенесенные дни.
- Показывает Help - краткую справку по использованию программы.
- Позволяет отправить сообщение разработчику и получать ответ прямо внутри бота.
- Имеет встроенный модуль (парсер) для получения расписания автобусов с сайта [Миноблавтотранс](https://gpmopt.by/mopt/Home/Index/sluck#/routes/bus).
- С помощью специальной команды может импортировать расписание полученное в результате парсинга в базу данных программы.
- Позволяет администраторам бота просматривать статистику использования бота.
- Имеет модуль для работы с Алисой. Позволяет получать расписание автобусов через голосового помощника.

## Разворачивание проекта ##

### Подготовка сервера ###

Необходимо подготовить сервер, установить PIP, GIT, virtualenv, Docker, Docker-compose (если предполагается работа в контейнере).
Клонировать репозиторий проекта с GitHub:  
`git@github.com:avdivo/nearest_bus.git`  

Зайти в папку проекта. Создать виртуальное окружение:  
`virtualenv venv`

Активировать виртуальное окружение:  
`source venv/bin/activate`  

Установить зависимости:  
`pip install -r requirements.txt`  

Выполнить миграции:  
`python manage.py migrate`

Создать суперпользователя:  
`python manage.py createsuperuser`

### Создание телеграмм бота ###
Необходимо создать телеграмм бота с помощью BotFather и получить токен.

### Настройка проекта ###
Создать файл .env в корне проекта и добавить в него следующие переменные:  
```
SECRET_KEY - Секретный ключ проекта Django
BOT_TOKEN - Токен телеграмм бота
ADMINS - [xxxxxxxxx, yyyyyyyyy]  # id в Телеграмм         администраторов бота
TELEGRAM_WEBHOOK_HOST - хост на который телеграмм должен присылать запросы (https://nearestbus.loca.lt)
TELEGRAM_WEBHOOK_PATH - маршрут для тг запросов (/schedule/tbot/)
OPENROUTER_API_KEY - API ключ для доступа к OpenRouter
```
#### Установка URL webhook в ТГ
Для задания URL адреса, куда телеграмм должен присылать запросы выполнить команду:
``` bash
python manage.py setwebhook
```
URL и токен ТГ берутся из файла .env

### Прздничные и перенесенные дни ###
Через админку в таблицу Праздники добавляются праздничные и перенесенные дни.  
Указывается дата и день недели, которым будет считаться эта дата.  
Даты содержат год, поэтому заполняться они должны постоянно.

### Импорт расписания ###
Расписание импортируется с сайта [Миноблавтотранс](https://gpmopt.by/mopt/Home/Index/sluck#/routes/bus).  
Парсинг сайта осуществляется программой start_import.py.  
Его запускаем на компьютере с графической оболочкой.  
После запуска нужно ввести автобус:
- Пустой ввод - все расписание
- Номер автобуса - только 1 автобус
- Номер автобуса с тире - от указанного автобуса до конца

Расписания сохраняются для каждого автобуса в отдельный файл в папке 
```
import_schedule/buses
```
После добавления указанных автобусов происходит сборка основного файла.
При сборке используется список автобусов из файла
```
import_schedule/busaes_list.py
```
Автобусы не указанные в списке не попадут в импорт, что будет указано в отчете.  
Автобусы указанные в списке, но для которых нет файлов, также будут отчете.  
Результирующий файл будет в корне проекта:
```
result.json
```
Этот файл нужно поместить в корень проекта на сервере и выполнить импорт:
```
manage.py import
```
Командой import расписание записывается в БД.  
Таблицы при этом должны быть созданы они будут перезаписаны. Список таблиц см. ниже.  
При импорте вносятся изменения в данные, относительно исходного расписания, 
их можно посмотреть в файле schedule/management/commands/import.py.

#### Сборка файла импорта без парсинга ####
Бывает нужно пересобрать файл импорта исключив какие то автобусы. Но при этом не парсить расписание по новому.  
Тогда в файле:
```
start_import.py
```
Нужно раскомментировать строки в начале файла:
```python
# Если нужно создать сводный файл, но не парсить
merge_json_files()
exit(0)
```
### Таблица вариантов названия ###
Таблица служит для сопоставления названия объектов (улицы, остановки, организации), 
как они называются на картах с жаргонными или разговорными названиями и вариантами произнесения. 
Таблицу можно посмотреть и отредактировать в админке Django (/admin/schedule/optionsforstopnames/).  

В ней указывается название в поле "Название" и в поле "Варианты названия" пишется Python список 
с альтернативными названиями.  В списке желательно писать и официальное название, но заменяя цифры 
словами, букву ё менять на е, все строчными буквами. И указывать названия как они могут быть произнесены 
пользователем. Например Социалистическая - ["социалистическая", "одиннадцатый", "одиннадцатый городок", 
"шанхай"] или Школа № 8 - ["школа номер восемь", "восьмая школа", "школа восемь"].  

Таблица может быть сохранена в JSON файл:
```bash
python manage.py save_options_name_for_bus_stop
```
будет создан файл "names_bus_stops.json".  

и восстановлена из файла:
```bash
python manage.py add_options_name_for_bus_stop
```
---------------------------------  
Иногда в названии сущности, где первое слово короткое (а их например 2), его веса может оказаться мало, чтобы пройти рубеж, после которого оно будет проверяться в сочетании со следующим. Тогда сущность может не распознаться.
Например "Дом культуры", слово "Дом" пропускается. Если добавить его в список альтернативных, то слово "Дом" в любом тексте будет определяться как сущность "Дом культуры."  
Чтобы такого не происходило, можно добавить это слово так: "домъъ" - этого достаточно, чтоб пройти порог отбора, но не достаточно, чтобы определять по слову "Дом" эту сущность.  
Или для слова "одиннадцать", чтобы не распознавать его как городок, слово "одиннадцатый" лучше записать как "одиннадцатыйъъ", тогда оно не будет однозначно определять сущность "Социалистическая" для слова "одиннадцать".

### Таблица группировки остановок ###
Чтобы расширить выбор остановок отправления и прибытия, которые которые будут рассматривать программой как возможные маршруты, можно группировать остановки.
Например:  
*на Автовокзал из центра города в основном идут 2 автобуса 6 и 16. Но 6-ка идет на Автовокзал, а 16 на Автовокзал кольцо. 
И если их не объединить, то при указании одной из этих остановок в качестве остановки прибытия, автобусы идущие на другую не будут указаны как подходящие.*
Одноименные остановки группируются автоматически, т.е. программа рассматривает возможность построения маршрута с одной из одноименных остановок, которую выбрал пользователи и с остановок, которые состоят с ней в группе. `За счет этого механизма решена проблема выбора остановки, когда один и тот же автобус может отправляться на какую либо остановку с любой из 2 остановок отправления (напримеравтобус №7 может доехать до ДК с любой из 2 остановок Чехова).`
Для реализации этого создана таблица в админке "Группы остановок" в разделе "Schedule". В ней можно записать группы остановок в формате JSON: 
```json
["Автовокзал", "Автовокзал кольцо"]
```
```json
["Поликлиника", "Гастелло", "Проектный институт", "Уреченская"]
```
Список групп находится в файле `docs/group_result.txt`, он не используется программой, просто для информации. Скрипты для составления списка в папке `docs/coordinates`.

## Команды бота ##
start - Перезапуск бота
help - Помощь
message - Сообщение разработчику. Через эту же команду можно ответить пользователю, но в начале сообщения нужно указать команду, которая появляется под сообщением пользователя.
stat - доступна только для администраторы, отсутствует в меню. Показывает короткую статистику использования бота.  

Регистрация пользователя в боте не требуется, происходит автоматически по команде start.

## Алиса ##
Для правильного распознавания остановок и команд необходимо заполнить таблицу Вариант названия автобусной остановки. 
В таблицу данные можно добавить через админку.
Также есть 2 команды:  
add_options_name_for_bus_stop - для добавления вариантов названий остановок из файла names_bus_stops.json (в корне проекта),  
save_options_name_for_bus_stop - для сохранения в файл из БД.  
В самой программе в файле alisa/services/analizer.py есть список слов, которые должны удаляться из фразы которую говорит пользователь Алисе, чтобы в дальнейшем они не анализировались.  
Регистрация пользователей происходит автоматически.  
Для работы Алисы на сайте Yandex в Яндекс.Диалоги нужно создать диалог и указать в нем путь к эндпоинту программы на сервере.

### Обращение к пользователю
С версии 2.0.0 появиласб возможность указать в параметрах пользователя Алисы его имя (как программа будет обращаться к пользователю). Для этого в таблице AlisaUser добавлено поле user_name. По наличию его содержимого определяется использовать персональное обращение к пользователю или общее. Поле заполняется вручную, возможно будет реализован механизм его задания.  
Обращение используется при приветствии или при вопросе выбора маршрута.

### Приветствие
С версии 2.0.0 программа приветствует пользователя раз в сутки, первый раз обращения в текущий день. Если у пользователя определено обращение, то приветствие будет персонализированным.  
Приветствие реализовано с использованием модели ИИ (через API). Для подстраховки (если модель не ответит, или если ответ задержится более чем на 1 секунду), приветствие будет выбрано из готовых шаблонов.

### Координаты
Есть список остановок с указанием координат для каждой. Список в формате excel. Он пока не используется в программе никак. Но с его помощью определялись группы близлежащих остановок. Сам список, скрипты и результаты работы, в том числе список групп остановок находится в папке `docs/coordinates`.

## Устройство

### Как работает выбор автобусов
В Телеграмм боте и в Алисе работает один алгоритм формирования списка автобусов. 
- Остановки пользователь задает по названиям, остановку отправления и остановку прибытия. 
- Для каждой из выбранных остановок определяются названия остановок которые входят с ней в одни группы. Группы объединяют близлежащие остановки, одноименные остановки автоматически считаются принадлежащими к одной группе.
- Выясняются все возможные маршруты между всеми остановками отправления и прибытия.
- Формируется список автобусов которые идут от остановок отправления к остановкам прибытия, на полный период (сутки).
- Определяются все временные метки, когда автобусы отправляются от остановок отправления, для каждого автобуса. Сортируются по времени.
- Определяется текущее время и по нему из списка временных меток определяется ближайший автобус, следующий за ним и т.д.

#### Представление расписания ближайших автобусов
Логика вабора примерно (она менялась) описана в документе `docs/Логика поиска остановок и автобусов на них.txt`. Сама программа реализована в файле `schedule/services/timestamp.py`.  
Программа сообщает ближайшее время после текущего, когда идет очередной автобус с любой из остановок отправления. Указывает автобус который отправляется и дополнительную информацию.  
Дополнительно сообщается:
- От какой конкретно остановки из группы остановок отправления (если остановка не одна), уходит этот автобус, если название остановки не совпадает с заданным пользователем, но в то же время они находятся в одной группе, а значит рядом. 
- На какую конкретно остановку прибывает автобус, если ее название отличается от заданной. 
- Конечная остановка того автобуса, который отправляется, в том случае, если автобус с этим же номером может отправляться с одноименной остановки (на противоположной стороне), на ту же остановку. Так можно отличить с какой остановки уходит автобус.
- Конечная остановка через которую идет автобус до остановки назначения, если нет маршрута, который идет не через конечную.
- Если автобус от остановки отправления на остановку прибытия идет через 2 конечные - это тоже сообщается. Но таких случаев не обнаружено.

#### Полное расписание
Выводится в Телеграмм боте по запросу.  
Расписание содержит информацию о времени отправления всех автобусов со всех одноименных остановок отправления. Обычно их 2, в разные стороны (но может быть 1 или больше 2).  
Расписание сгруппировано и отсортировано по автобусам. Для каждого автобуса указано направление двидения (маршрут, конечные остановки). И для каждой остановки список временных меток когда этот автобус отправляется.  
Дла получения полного расписания, после каждого информационного сообщения с расписанием, выводится клавиатура с днями недели. Таким образом можно выбрать на какой день недели нужно расписание.

### Таблицы приложения
alisa_alisauser - пользователи Алисы  
schedule_bus - автобусы (очистить перед импортом)  
schedule_busstop - остановки (очистить перед импортом)  
schedule_busstop_con_from - связь остановок с маршрутами (очистить перед импортом)  
schedule_busstop_con_to - связь остановок с маршрутами (очистить перед импортом)  
schedule_bus_station - остановки на маршруте (очистить перед импортом)  
schedule_holiday - праздничные и перенесенные дни  
schedule_optionsforstopnames - варианты названий остановок  
schedule_order - порядок остановок на маршруте (очистить перед импортом)  
schedule_router - маршруты (очистить перед импортом)  
schedule_schedule - расписание автобусов (очистить перед импортом)  
tbot_botuser - пользователи бота  
tbot_idsforname - внутренняя таблица для бота для замены названий кнопок идефикаторами  
tbot_parameter - настройки пользователей  

### Поддержка AI
Для реализации функций AI есть набор инструментов
``` path
nb/services/AI
```
openrouter.py - API запросы к OpenRouter
parse_md.py - разбор md файлов
prompts - файлы промптов в формате md

#### Промпты
Функция query_openrouter в openrouter.py принимает среди прочего параметр prompt_name, это название ыайла из папки prompts без расшитения из которого будет прочитан промпт. Файл должен содержать 2 раздела:  
- SYSTEM - системный промпт (ты...)
- PROMPT - основной промпт.
```
# SYSTEM
...

# PROMPT
...
```