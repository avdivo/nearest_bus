# –ú–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—é –ø–æ –ú–µ–Ω—é.
# –ú–µ–Ω—é - —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞.
# –û—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º.

# –ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ —Å–≤–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
# –ü–æ –Ω–µ–º—É –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤ –∫–∞–∫–æ–º –º–µ—Å—Ç–µ –º–µ–Ω—é –Ω–∞—Ö–æ–¥–∏—Ç—Å—è
# –∏ –ø–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º -
# –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—ä–µ–∫—Ç –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∏ –∑–∞–ø—É—Å–∫ –µ–≥–æ –º–µ—Ç–æ–¥–∞.

from django.core.exceptions import PermissionDenied

from telebot import types

from tbot.services.executors import Executor, ExeAddBusStop, MyRouter, MyRouterSetting
from tbot.services.functions import authorize
from alisa.services.talk_to_alisa import answer_to_alisa


def menu(bot, message, open_menu=None):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –º–µ–Ω—é.
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –∏–∑ —Ç–µ–ª–µ–≥—Ä–∞–º–º.
    –¢—Ä–µ—Ç–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å - —ç—Ç–æ –º–µ–Ω—é, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å."""

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–ª–∞–≤–∏–∞—Ç—É—Ä
    kb = dict()

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    settings_menu = {
        '–ù–∞—Å—Ç—Ä–æ–π–∫–∏': [
            {'üöè –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç': ExeAddBusStop, 'Ô∏èÔ∏è‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç': MyRouterSetting},
            # {'–ù–∞–∑–∞–¥': '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ'}
            {'‚¨ÖÔ∏è –ù–∞–∑–∞–¥': '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é'}
        ]
    }

    # –ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    full_shedule_menu = {
        '–ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ': [
            {'–° –æ—Å—Ç–∞–Ω–æ–≤–∫–∏': Executor, '–ü–æ –º–∞—Ä—à—Ä—É—Ç—É': Executor},
            {'‚¨ÖÔ∏è –ù–∞–∑–∞–¥': '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ'}
        ]
    }

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
    add_menu = {
        '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ': [
            {'üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', '–ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ': '–ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ'},
            {'‚¨ÖÔ∏è –ù–∞–∑–∞–¥': '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é'}
        ]
    }

    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    main_menu = {
        '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é': [
            # {'–ú–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã': MyRouter, '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ': '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ'},
            {'üöå –ú–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã': MyRouter, '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'},
        ]
    }

    # –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ –º–µ–Ω—é –≤ –æ–¥–∏–Ω —Å–ª–æ–≤–∞—Ä—å
    kb.update(main_menu)
    kb.update(add_menu)
    kb.update(settings_menu)
    kb.update(full_shedule_menu)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = authorize(message.from_user)
    if not user:
        # –î–ª—è –±–æ—Ç–æ–≤
        raise PermissionDenied

    if not open_menu:
        # –ò—â–µ–º –≤ —Ç–µ–∫—É—â–µ–º –º–µ–Ω—é —Å–ª–æ–≤–æ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–∂–∞—Ç—É—é –∫–Ω–æ–ø–∫—É)
        point_menu = None
        for item in kb[user.user_menu]:
            if message.text in item:
                # –ù–∞–π–¥–µ–Ω–∞ –Ω–∞–∂–∞—Ç–∞—è –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é (–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
                point_menu = item[message.text]
                break
    else:
        # –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –≤–≤–µ–¥–µ–Ω–æ, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ª—é–±–æ–µ –º–µ–Ω—é. –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        point_menu = open_menu

    # –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–æ–º—É –º–µ–Ω—é (–∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ) –≤ –Ω–∞–π–¥–µ–Ω–Ω–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –±—É–¥–µ—Ç str
    # –ï—Å–ª–∏ —Ç–∞–º –Ω–µ —Å—Ç—Ä–æ–∫–∞ - –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –æ–∫–Ω–µ —á–∞—Ç–∞ –∏–ª–∏ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ.
    # –ï—Å–ª–∏ —Ç–∞–º None - –∑–Ω–∞—á–∏—Ç –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–µ–Ω —Ç–µ–∫—Å—Ç.
    if isinstance(point_menu, str):
        # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–æ–≤–æ–µ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user.user_menu = point_menu
        user.save()

        # –í —Å–ø–∏—Å–∫–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤–∞—Ä–µ–π - —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫,
        # –∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π –≤ —Å–ª–æ–≤–∞—Ä–µ - —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫ –≤ —Å—Ç—Ä–æ–∫–µ.
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –≤–∏–¥–∞
        markup = types.ReplyKeyboardMarkup(resize_keyboard=
     True)
        for item in kb[point_menu]:
            markup.row(*(types.KeyboardButton(button) for button in item.keys()))
        bot.send_message(message.chat.id, f'{point_menu}', reply_markup=markup)
        return

    # –ú—ã –ø—Ä–∏—à–ª–∏ —Å—é–¥–∞ –µ—Å–ª–∏ –≤ point_menu –ø—É—Å—Ç–æ –∏–ª–∏ —Ç–∞–º –∏–º—è –∫–ª–∞—Å—Å–∞ –Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã.
    if point_menu:
        # –ï—Å–ª–∏ –≤ point_menu –∫–ª–∞—Å—Å, —Ç–æ —ç—Ç–æ –Ω–∞—á–∞–ª–æ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ –æ–∫–Ω–µ —á–∞—Ç–∞
        point_menu(bot, user, message, action=True)
        return

    # –ï—Å–ª–∏ –≤ point_menu –ø—É—Å—Ç–æ, —Ç–æ –≤ message.text —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
    # –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω—É–∂–µ–Ω –ø—Ä–æ–≥—Ä–∞–º–º–µ –≤ –æ–∫–Ω–µ —á–∞—Ç–∞, –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ.
    # –ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–∏–º None, –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–≥—Ä–∞–º–º–µ –æ–Ω –Ω–µ –Ω—É–∂–µ–Ω.
    if user.parameter.class_name:
        # –í –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π class_name —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã,
        # –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç,
        # –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã.
        # print(user.parameter.class_name)

        answer = globals()[user.parameter.class_name](bot, user, message)

        # –¢—É—Ç –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ answer is None.

        # print(f"–û—Ç–≤–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã: {answer.answer}", message.text)
        if answer.answer is None:
            # –¢–µ–ª–µ–≥—Ä–∞–º –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª –∑–∞–ø—Ä–æ—Å, –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –ê–ª–∏—Å–µ
            # –ü—Ä–∏ —ç—Ç–æ–º –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ê–ª–∏—Å–µ
            request_body = {
                'session': {
                    'application': {
                        'application_id': f'tg_{user.user_id}_name_{user.user_name}_login_{user.user_login}'
                    }
                },
                'request': {
                    'original_utterance': message.text
                }
            }
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç –ê–ª–∏—Å—ã –≤ —Ç–µ–ª–µ–≥—Ä–∞–º
            bot.send_message(message.chat.id, answer_to_alisa(request_body))

        return
    else:
        # –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã, —Å–æ–æ–±—â–∞–µ–º –æ–± –æ—à–∏–±–∫–µ, —Ç–∞–∫–æ–≥–æ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:")
        bot.send_message(message.chat.id, "–ó–∞–ø—Ä–æ—Å –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.")
